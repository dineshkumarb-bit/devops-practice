This is a merged version from both branches

